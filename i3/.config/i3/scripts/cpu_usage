#!/usr/bin/env bash
# Lightweight CPU usage script - reads /proc/stat directly
# Replaces the mpstat-based version which took 1 second per call

CACHE_FILE="/tmp/.i3blocks_cpu_usage"
T_WARN=${T_WARN:-50}
T_CRIT=${T_CRIT:-80}

read -r cpu user nice system idle iowait irq softirq steal _ < /proc/stat

total=$((user + nice + system + idle + iowait + irq + softirq + steal))

if [[ -f "$CACHE_FILE" ]]; then
    read -r prev_total prev_idle < "$CACHE_FILE"
    diff_total=$((total - prev_total))
    diff_idle=$((idle - prev_idle))
    if ((diff_total > 0)); then
        usage=$((100 * (diff_total - diff_idle) / diff_total))
    else
        usage=0
    fi
else
    usage=0
fi

echo "$total $idle" > "$CACHE_FILE"

# full_text
printf "%d%%\n" "$usage"
# short_text
printf "%d%%\n" "$usage"

# color
if ((usage >= T_CRIT)); then
    echo "#FF0000"
    exit 33
elif ((usage >= T_WARN)); then
    echo "#FFFC00"
fi

exit 0
